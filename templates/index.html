{% extends "base.html" %}

{% block content %}
<section class="cards">
  <article class="card highlight">
    <h2>总支出</h2>
    <p class="metric negative">¥{{ '%.2f'|format(totals.get('withdrawal', 0)) }}</p>
  </article>
  <article class="card highlight">
    <h2>总收入</h2>
    <p class="metric positive">¥{{ '%.2f'|format(totals.get('deposit', 0)) }}</p>
  </article>
  <article class="card highlight">
    <h2>净流入</h2>
    <p class="metric {{ 'positive' if totals.get('net', 0) >= 0 else 'negative' }}">¥{{ '%.2f'|format(totals.get('net', 0)) }}</p>
  </article>
  <article class="card highlight">
    <h2>转账总额</h2>
    <p class="metric">¥{{ '%.2f'|format(totals.get('transfer', 0)) }}</p>
  </article>
</section>

<section class="chart-row">
  <article class="panel large">
    <h3>月度收支趋势</h3>
    <canvas id="monthlyTrends"></canvas>
  </article>
</section>

<section class="chart-row">
  <article class="panel">
    <h3>支出类别 TOP 5</h3>
    <canvas id="spendingCategories"></canvas>
  </article>
  <article class="panel">
    <h3>收入类别 TOP 5</h3>
    <canvas id="incomeCategories"></canvas>
  </article>
  <article class="panel">
    <h3>主要转入账户</h3>
    <canvas id="transferAccounts"></canvas>
  </article>
</section>

<section class="chart-row">
  <article class="panel">
    <h3>支出来源账户 TOP 5</h3>
    <ul class="list">
      {% for name, amount in top_source_accounts %}
      <li><span>{{ name }}</span><span>¥{{ '%.2f'|format(amount) }}</span></li>
      {% else %}
      <li class="empty">暂无数据</li>
      {% endfor %}
    </ul>
  </article>
  <article class="panel">
    <h3>收入目标账户 TOP 5</h3>
    <ul class="list">
      {% for name, amount in top_destination_accounts %}
      <li><span>{{ name }}</span><span>¥{{ '%.2f'|format(amount) }}</span></li>
      {% else %}
      <li class="empty">暂无数据</li>
      {% endfor %}
    </ul>
  </article>
</section>

<script>
  const monthlyLabels = {{ monthly_labels|tojson }};
  const monthlyWithdrawals = {{ monthly_withdrawals|tojson }};
  const monthlyDeposits = {{ monthly_deposits|tojson }};
  const monthlyTransfers = {{ monthly_transfers|tojson }};

  const spendingCategories = {{ top_spending_categories|tojson }};
  const incomeCategories = {{ top_income_categories|tojson }};
  const transferAccounts = {{ top_transfer_accounts|tojson }};

  const palette = {
    withdrawal: '#ff6b6b',
    deposit: '#4dabf7',
    transfer: '#f7b84b',
    neutral: '#ced4da'
  };

  const trendCtx = document.getElementById('monthlyTrends');
  new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: monthlyLabels,
      datasets: [
        {
          label: '支出',
          data: monthlyWithdrawals,
          borderColor: palette.withdrawal,
          backgroundColor: 'rgba(255, 107, 107, 0.1)',
          tension: 0.35,
          fill: true,
        },
        {
          label: '收入',
          data: monthlyDeposits,
          borderColor: palette.deposit,
          backgroundColor: 'rgba(77, 171, 247, 0.1)',
          tension: 0.35,
          fill: true,
        },
        {
          label: '转账',
          data: monthlyTransfers,
          borderColor: palette.transfer,
          backgroundColor: 'rgba(247, 184, 75, 0.1)',
          tension: 0.35,
          fill: true,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { labels: { color: '#f1f3f5' } },
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.parsed.y || 0;
              return `${context.dataset.label}: ¥${value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
          }
        }
      },
      scales: {
        x: {
          ticks: { color: '#dee2e6' },
          grid: { color: 'rgba(255, 255, 255, 0.05)' }
        },
        y: {
          ticks: {
            color: '#dee2e6',
            callback: value => `¥${value}`
          },
          grid: { color: 'rgba(255, 255, 255, 0.08)' }
        }
      }
    }
  });

  function renderHorizontalBar(canvasId, dataset, color) {
    const ctx = document.getElementById(canvasId);
    const labels = dataset.map(item => item[0]);
    const values = dataset.map(item => item[1]);

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          {
            data: values,
            backgroundColor: color,
            borderRadius: 8,
            barThickness: 24,
          }
        ]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: context => `¥${context.parsed.x.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
            }
          }
        },
        scales: {
          x: {
            ticks: { color: '#dee2e6' },
            grid: { color: 'rgba(255, 255, 255, 0.05)' }
          },
          y: {
            ticks: { color: '#dee2e6' },
            grid: { display: false }
          }
        }
      }
    });
  }

  renderHorizontalBar('spendingCategories', spendingCategories, palette.withdrawal);
  renderHorizontalBar('incomeCategories', incomeCategories, palette.deposit);
  renderHorizontalBar('transferAccounts', transferAccounts, palette.transfer);
</script>
{% endblock %}
